<% project ||= @project %>
<% component ||= @component %>
<% messages.each do |message| %>
  <% if message.role == "user" %>
    <div class="d-flex justify-content-end mb-2">
      <div class="message-box user-message px-3 pb-0 pt-3 rounded-3">
        <%= raw(render_markdown(message.content)) %>
      </div>
    </div>
  <% elsif message.role == "assistant" %>
    <% parsed = JSON.parse(message.content) rescue nil %>
    <div class="d-flex justify-content-start mb-5">
      <div class="px-3 pb-0 pt-3 w-100">
        <% if parsed.present? && parsed["html"].present? %>
          <%
            preview_html = parsed['html'].gsub(/href="#"/, 'href="javascript:void(0)"')
            preview_css = parsed['css'].present? ? parsed['css'] : ''
            use_bootstrap = parsed['bootstrap'] == true

            resize_script = "function reportSize(){var h=document.body.scrollHeight;window.parent.postMessage({type:'iframeResize',height:h},'*');}window.addEventListener('load',reportSize);setTimeout(reportSize,100);setTimeout(reportSize,500);"
            iframe_content = "<!DOCTYPE html><html lang='en'><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1.0'>"
            iframe_content += "<link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' rel='stylesheet'>" if use_bootstrap
            iframe_content += "<style>html,body{margin:0;padding:0;height:auto;min-height:0;}body{background:#ffffff;padding:8px;}#{preview_css}</style></head><body>#{preview_html}"
            iframe_content += "<script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js'></script>" if use_bootstrap
            iframe_content += "<script>#{resize_script}</script></body></html>"
          %>
          <div class="row">
            <div class="col-4 code-card">
              <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                  <button class="code-nav nav-link active" id="nav-html<%= message.id %>-tab" data-bs-toggle="tab" data-bs-target="#nav-html<%= message.id %>" type="button" role="tab" aria-controls="nav-html<%= message.id %>" aria-selected="true">HTML</button>
                  <button class="code-nav nav-link" id="nav-css<%= message.id %>-tab" data-bs-toggle="tab" data-bs-target="#nav-css<%= message.id %>" type="button" role="tab" aria-controls="nav-css<%= message.id %>" aria-selected="false">CSS</button>
                </div>
              </nav>
              <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade show active" id="nav-html<%= message.id %>" role="tabpanel" aria-labelledby="nav-html<%= message.id %>-tab" tabindex="0">
                  <pre><code class="language-html"><%= HtmlBeautifier.beautify(parsed["html"]) %></code></pre>
                </div>
                <div class="tab-pane fade" id="nav-css<%= message.id %>" role="tabpanel" aria-labelledby="nav-css<%= message.id %>-tab" tabindex="0">
                  <pre><code class="language-css"><%= parsed["css"].present? ? CssBeautify.beautify(parsed["css"]) : "" %></code></pre>
                </div>
              </div>
            </div>
            <div class="col-6">
              <iframe srcdoc="<%= h(iframe_content) %>" data-controller="iframe-resize" data-iframe-resize-min-height-value="100" style="width: 100%; height: 100px; border: 1px solid #30363d; border-radius: 8px; background: #ffffff;"></iframe>
            </div>
            <div class="col-2">
              <%= button_to "Save to Components", project_component_path(project, component), method: :patch, params: { component: { html_code: parsed["html"], css_code: parsed["css"] }}, class: "btn btn-primary" %>
            </div>
          </div>
        <% else %>
          <%= raw(render_markdown(message.content)) %>
        <% end %>
      </div>
    </div>
  <% end %>
<% end %>
